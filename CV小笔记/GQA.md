GQA 在深度学习中指的是 **Grouped Query Attention（分组查询注意力）**。它是一种在大型语言模型 (LLMs) 中优化 Transformer 架构中注意力机制的技术，旨在平衡 **Multi-Head Attention (MHA)** 的高质量和 **Multi-Query Attention (MQA)** 的高效率。

为了更好地理解 GQA，我们需要先回顾一下 MHA 和 MQA：

### 1. Multi-Head Attention (MHA)

- **原理：** MHA 是 Transformer 模型中标准的注意力机制。它将输入（查询 Q、键 K、值 V）分别投影到多个“头”（`H` 个）上，每个头独立计算注意力，然后将所有头的输出拼接起来，再进行一次线性投影得到最终输出。
- **优点：** * 每个头可以学习关注输入序列的不同方面或表示子空间，从而捕获更丰富的语义和多角度的信息。
    - 模型的表达能力强，通常能达到最佳性能。
- **缺点：** * 在解码（生成文本）阶段，特别是自回归模型（每次生成一个 token），MHA 需要为每个头维护一套独立的键（K）和值（V）缓存（KV Cache）。随着序列长度和模型参数的增加，KV Cache 会变得非常庞大，占用大量显存，成为推理时的主要瓶颈。

### 2. Multi-Query Attention (MQA)

- **原理：** MQA 是一种优化 MHA 的方法，其核心思想是让**所有的查询头（Query Heads）共享一套键（Key）和值（Value）头**。也就是说，无论有多少个 Query Head，都只使用一个 Key Head 和一个 Value Head。
- **优点：** * 显著减少了 KV Cache 的大小，因为只需要存储一组 K 和 V。
    - 大大提高了推理速度和效率，尤其是在自回归解码场景下，因为每次解码步都需要访问 KV Cache。
- **缺点：** * 由于所有 Query Head 共享相同的 K 和 V，可能会降低模型的表达能力和性能，因为它失去了 MHA 中多头捕获不同信息的能力，可能导致注意力多样性不足，从而略微牺牲模型质量。

### 3. Grouped Query Attention (GQA)

- **原理：** GQA 介于 MHA 和 MQA 之间，是两者的泛化。它将查询头分成 G 个组（Group），**每个组内的查询头共享一套键（K）和值（V）头**。
    - 当 G 等于查询头的数量时，GQA 退化为 MHA（每个 Query Head 有独立的 K/V Head）。
    - 当 G 等于 1 时，GQA 退化为 MQA（所有 Query Head 共享一个 K/V Head）。
    - 通常，GQA 会选择一个 G 值，使得 1<G<H (H 是查询头的总数)。
- **优点：** * **平衡性：** GQA 在 MHA 的高质量和 MQA 的高效率之间找到了一个折衷点。它比 MQA 拥有更多的 K/V 头，从而保留了更多的表达能力和注意力多样性，使模型质量更接近 MHA。
    - **效率：** 与 MHA 相比，GQA 显著减少了 KV Cache 的大小和内存带宽需求（只需要存储 G 套 K/V 头），从而加快了推理速度，特别是对于大型模型。
    - **可扩展性：** 能够更好地适应大型模型的需求，允许在保持良好性能的同时，处理更大的模型和更长的序列。

### 总结比较

|   |   |   |   |
|---|---|---|---|
|**特性 / 机制**|**Multi-Head Attention (MHA)**|**Multi-Query Attention (MQA)**|**Grouped Query Attention (GQA)**|
|Query Heads|`H` 个独立的|`H` 个独立的|`H` 个独立的|
|Key/Value Heads|`H` 个独立的|1 个共享的|`G` 个共享的 (`1 < G < H`)|
|KV Cache 大小|最大（`H` 倍于 MQA）|最小（1倍）|中等（`G` 倍于 MQA）|
|推理速度|慢|快|较快（接近 MQA）|
|模型质量/表达能力|高|可能略有下降|接近 MHA（优于 MQA）|
|适用场景|训练阶段，或对推理速度不敏感的场景|对推理速度和内存效率要求极高的场景|LLM 推理（当前主流大型模型的常用优化方案）|

GQA 已经成为许多先进 LLM（如 Llama 2、Falcon 40B 等）中的标准注意力机制，因为它在实际部署中提供了卓越的推理效率，同时对模型性能的影响微乎其微，使其成为大型模型推理优化的重要技术。
